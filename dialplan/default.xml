<include>
  <context name="default">

    <extension name="unloop">
      <condition field="${unroll_loops}" expression="^true$"/>
      <condition field="${sip_looped_call}" expression="^true$">
	        <action application="deflect" data="${destination_number}"/>
      </condition>
    </extension>


    <!-- Определения контакта в БД, при наборе номера идет поиск в БД и подставляется вместо номера ФИО -->
    
    <extension name="cid_number_cleanup" continue="true">
      <condition field="destination_number" expression="^(\d{4})$">
        <action application="set" data="initial_callee_id_number=$1" inline="true"/>
      </condition>
    </extension>
    
    <extension name="cid_name_cleanup" continue="true">
      <condition field="destination_number" expression="^(\d{4})$">
        <action application="set" data="initial_callee_id_name=$1" inline="true"/>
      </condition>
    </extension>
    
    <extension name="cid_lookup-country_code_1" continue="true">
      <condition field="${module_exists(mod_cidlookup)}" expression="true"/>
      <condition field="destination_number" expression="^(\d{4})$">
        <action application="set" data="initial_callee_id_name=${cidlookup($1)}"/>
        <action application="log" data="INFO cidlookup initial_callee_id_name = ${initial_callee_id_name}"/>
        
      </condition>
    </extension>
    <!-- Конец Определения контакта -->



    <extension name="local-account-hello">
      <condition field="destination_number" expression="^3000$">
        <action application="answer"/>

        <action application="playback" data="local_stream://moh"/>
      </condition>
    </extension>

    <!-- <extension name="Simple Lua Test">
      <condition field="destination_number" expression="^(3333)$">
          <action application="set" data="hangup_after_bridge=true"/>
          <action application="set" data="continue_on_fail=true"/>
          <action application="set" data="ignore_early_media=true"/>
          <action application="lua" data="test3.lua"/>
      </condition>
     </extension> -->
   <extension name="Local call">
      <condition field="destination_number" expression="^(10\d{2})$">
          <action application="set" data="hangup_after_bridge=true"/>
          <action application="set" data="continue_on_fail=true"/>
          <action application="set" data="ignore_early_media=true"/>
          <!-- Запись разговора поле ответа -->
          <!-- <action application="set" data="media_bug_answer_req=true"/>  -->
          <!-- <action application="record_session" data="$${recordings_dir}/${strftime(%Y-%m-%d-%H-%M-%S)}_${destination_number}_${caller_id_number}.wav"/> -->
          <!-- <action application="set" data="initial_callee_id_name=${cidlookup($1)}"/> -->
          <!-- <action application="set" data="initial_callee_id_number=${dialed_extension}"/> -->
          <!-- <action application="set" data="initial_callee_id_name=${user_data(${dialed_extension}@${domain_name} var effective_caller_id_name)}"/> 
	        <action application="set" data="effective_caller_id_number=${user_data(${caller_id_number}@${domain_name} var effective_caller_id_number)}"/> -->
          <action application="lua" data="$${lua_scripts_dir}/call_local_number.lua"/>
      </condition>

    </extension>
    <extension name="Call group">
      <condition field="destination_number" expression="^(99\d{2}|88\d{2})$">
          <action application="set" data="hangup_after_bridge=true"/>
          <action application="set" data="continue_on_fail=true"/>
          <action application="set" data="ignore_early_media=true"/>
          <!-- <action application="set" data="initial_callee_id_name=${user_data(${dialed_extension}@${domain_name} var effective_caller_id_name)}"/> 
	        <action application="set" data="effective_caller_id_number=${user_data(${caller_id_number}@${domain_name} var effective_caller_id_number)}"/> -->
          <action application="lua" data="$${lua_scripts_dir}/call_local_groupcall.lua"/>
      </condition>

    </extension>

    <extension name="nb_conferences">
      <condition field="destination_number" expression="^(15\d{2})$">
        <action application="lua" data="$${lua_scripts_dir}/conference.lua"/>
        <!-- <action application="answer"/>

        <action application="set" data="conference_auto_outcall_timeout=5"/>
        <action application="set" data="conference_utils_auto_outcall_flags=mute"/> 
        <action application="set" data="conference_auto_outcall_caller_id_name='Тестовая конференция'"/>
        <action application="set" data="conference_auto_outcall_caller_id_number='1500'"/>
        <action application="set" data="conference_auto_outcall_profile=default"/>
        <action application="set" data="conference_auto_outcall_prefix={sip_auto_answer=false,execute_on_answer='bind_meta_app 2 a s1 transfer::intercept:${uuid} inline'}"/>
        <action application="set" data="conference_auto_outcall_timeout=60"/>

        <action application="conference_set_auto_outcall" data="user/1026tel@$${domain}"/>
        <action application="conference_set_auto_outcall" data="user/1027rc@$${domain}"/> 
        <action application="conference_set_auto_outcall" data="user/1025rc@$${domain}"/> 
        <action application="conference" data="$1-${domain_name}@default+12345"/> -->
      </condition>
    </extension>


    <!-- <extension name="dvop_groupcall">
     <condition field="destination_number" expression="1200">
       <action application="answer"/>
       <action application="set" data="ringback=$${hold_music}"/> 
       <action application="set" data="call_timeout=60"/>
       <action application="set" data="hangup_after_bridge=true"/>
       <action application="bridge" data="${group_call(group_1200@${domain_name}+A)}"/>
     </condition>
   </extension> -->

    <!-- <extension name="Group call">
       <condition field="destination_number" expression="1100">
         <action application="set" data="hangup_after_bridge=true"/>
         <action application="set" data="continue_on_fail=true"/>
         <action application="set" data="originate_continue_on_timeout=true"/>
         <action application="set" data="call_timeout=15"/>
         <action application="bridge" data="${group_call(1100@${domain_name}+A)}"/>
         
         <action application="hangup"/>
       </condition>
     </extension> -->

     <!-- <extension name="Internal calls">
        <condition field="destination_number" expression="^(10\d{2})$">
            <action application="bridge" data="user/$1@$${domain_name}"/> 
       </condition>
    </extension>

    <extension name="sample">
      <condition>
        <action application="info"/>
      </condition>
    </extension> -->

  </context>
</include>
